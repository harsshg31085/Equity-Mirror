<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equity Mirror - Real-Time Bias Detection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --primary-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --surface: #ffffff;
            --background: #f8fafc;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }

        .logo-text p {
            color: var(--text-light);
            font-size: 14px;
        }

        .stats-bar {
            display: flex;
            gap: 32px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            flex: 1;
        }

        /* Editor Panel */
        .editor-panel {
            background: var(--surface);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
        }

        .editor-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Text Editor */
        .text-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--background);
            border-radius: 12px;
            overflow: hidden;
        }

        #text-input {
            flex: 1;
            width: 100%;
            padding: 24px;
            border: none;
            background: transparent;
            font-size: 16px;
            line-height: 1.8;
            resize: none;
            font-family: 'Georgia', serif;
            color: var(--text);
        }

        #text-input:focus {
            outline: none;
        }

        #text-input::placeholder {
            color: var(--text-light);
            font-style: italic;
        }

        .editor-footer {
            padding: 16px 24px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-light);
            font-size: 14px;
        }

        /* Results Panel */
        .results-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Score Card */
        .score-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .score-circle {
            width: 180px;
            height: 180px;
            margin: 0 auto 24px;
            position: relative;
        }

        .score-circle svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .score-circle circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }

        .score-bg {
            stroke: var(--border);
        }

        .score-progress {
            stroke: var(--primary);
            stroke-dasharray: 440;
            stroke-dashoffset: calc(440 - (440 * var(--score, 0)) / 100);
            transition: stroke-dashoffset 0.5s ease;
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
            font-weight: 700;
            color: var(--primary);
        }

        .score-label {
            font-size: 14px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        /* Bias Types */
        .bias-types {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .bias-types h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        .bias-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .legend-item:hover {
            background: var(--background);
        }

        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-text {
            font-size: 14px;
            color: var(--text);
        }

        .legend-count {
            margin-left: auto;
            font-weight: 600;
            color: var(--primary);
        }

        /* Suggestions Panel */
        .suggestions-panel {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            flex: 1;
        }

        .suggestions-panel h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        #suggestions-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Suggestion Item */
        .suggestion-item {
            background: var(--background);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            transition: transform 0.2s;
        }

        .suggestion-item:hover {
            transform: translateX(4px);
        }

        .suggestion-text {
            font-size: 14px;
            color: var(--text);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .suggestion-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .suggestion-replace {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .suggestion-replace:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Bias Highlights */
        .bias-highlight {
            padding: 2px 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-weight: 500;
        }

        .bias-highlight:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .bias-highlight::after {
            content: 'üõà';
            font-size: 10px;
            margin-left: 4px;
            opacity: 0.7;
        }

        /* Tooltip */
        .bias-tooltip {
            position: absolute;
            background: var(--surface);
            color: var(--text);
            padding: 12px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
            display: none;
        }

        .bias-tooltip.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 24px;
            color: white;
            font-size: 14px;
            opacity: 0.9;
            margin-top: 24px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="logo-text">
                    <h1>Equity Mirror</h1>
                    <p>Real-time language bias detection</p>
                </div>
            </div>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-value" id="real-time-score">100</span>
                    <span class="stat-label">Score</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="real-time-words">0</span>
                    <span class="stat-label">Words</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="real-time-biases">0</span>
                    <span class="stat-label">Biases</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Editor Panel -->
            <div class="editor-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-edit"></i> Write Your Text</h2>
                    <div class="editor-toolbar">
                        <button id="clear-btn" class="btn btn-secondary">
                            <i class="fas fa-broom"></i> Clear
                        </button>
                        <button id="demo-btn" class="btn btn-secondary">
                            <i class="fas fa-magic"></i> Load Demo
                        </button>
                    </div>
                </div>

                <div class="text-editor">
                    <textarea id="text-input" style="display: none;"></textarea>
                    
                    <div 
                        id="editable-text" 
                        class="editable-textarea"
                        contenteditable="true"
                        placeholder="Start typing here..."
                        autofocus
                    ></div>
                    
                    <div class="editor-footer">
                        <div class="char-count">
                            <span id="word-count">0</span> words
                        </div>
                        <div class="status">
                            <span id="status-indicator">‚óè Ready</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <!-- Score Card -->
                <div class="score-card">
                    <div class="score-circle">
                        <svg viewBox="0 0 36 36">
                            <circle cx="18" cy="18" r="16" class="score-bg"></circle>
                            <circle cx="18" cy="18" r="16" class="score-progress" 
                                    id="score-circle"></circle>
                        </svg>
                        <div class="score-value" id="score-value">100</div>
                    </div>
                    <div class="score-label">Inclusivity Score</div>
                </div>

                <!-- Bias Types -->
                <div class="bias-types">
                    <h3><i class="fas fa-tags"></i> Detected Biases</h3>
                    <div class="bias-legend">
                        <div class="legend-item" data-type="pronoun">
                            <div class="color-dot" style="background: #ef4444;"></div>
                            <span class="legend-text">Pronoun Bias</span>
                            <span class="legend-count" id="count-pronoun">0</span>
                        </div>
                        <div class="legend-item" data-type="agentic">
                            <div class="color-dot" style="background: #f59e0b;"></div>
                            <span class="legend-text">Agentic/Communal</span>
                            <span class="legend-count" id="count-agentic">0</span>
                        </div>
                        <div class="legend-item" data-type="gendered">
                            <div class="color-dot" style="background: #10b981;"></div>
                            <span class="legend-text">Gendered Terms</span>
                            <span class="legend-count" id="count-gendered">0</span>
                        </div>
                        <div class="legend-item" data-type="semantic">
                            <div class="color-dot" style="background: #3b82f6;"></div>
                            <span class="legend-text">Semantic Bias</span>
                            <span class="legend-count" id="count-semantic">0</span>
                        </div>
                        <div class="legend-item" data-type="stereotype">
                            <div class="color-dot" style="background: #8b5cf6;"></div>
                            <span class="legend-text">Stereotypes</span>
                            <span class="legend-count" id="count-stereotype">0</span>
                        </div>
                    </div>
                </div>

                <!-- Suggestions -->
                <div class="suggestions-panel">
                    <h3><i class="fas fa-lightbulb"></i> Suggestions</h3>
                    <div id="suggestions-container">
                        <div class="empty-state">
                            <i class="fas fa-comment-alt"></i>
                            <p>Click on any highlighted text to see suggestions for improvement.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Equity Mirror &copy; 2025 | Built for Lady Ada Lovelace Challenge | IIT Kanpur</p>
            <p>Real-time bias detection powered by AI</p>
        </footer>

        <!-- Hidden div for highlighted text -->
        <div id="highlighted-content" style="display: none;"></div>
    </div>

    <script>
        class EquityMirror {
            constructor() {
                this.currentText = '';
                this.currentBiases = [];
                this.debounceTimer = null;
                this.currentSuggestion = null;
                this.lastCursorPosition = null;
                this.isUpdatingHighlights = false;
                this.shouldSkipNextAnalysis = false; // NEW: Prevent analysis after space
                
                this.initializeElements();
                this.bindEvents();
                this.setupEventListeners();
                this.loadInitialDemo();
                
                // Set initial height
                this.adjustEditorHeight();
            }
            
            initializeElements() {
                this.textInput = document.getElementById('text-input'); // Hidden textarea
                this.editableDiv = document.getElementById('editable-text'); // Visible contenteditable div
                this.scoreCircle = document.getElementById('score-circle');
                this.scoreValue = document.getElementById('score-value');
                this.realTimeScore = document.getElementById('real-time-score');
                this.realTimeWords = document.getElementById('real-time-words');
                this.realTimeBiases = document.getElementById('real-time-biases');
                this.wordCount = document.getElementById('word-count');
                this.statusIndicator = document.getElementById('status-indicator');
                this.suggestionsContainer = document.getElementById('suggestions-container');
                this.editorPanel = document.querySelector('.editor-panel');
                
                // Bias count elements - match these with backend bias types
                this.biasCounts = {
                    'pronoun': document.getElementById('count-pronoun'),
                    'agentic_communal': document.getElementById('count-agentic'),
                    'gendered_terms': document.getElementById('count-gendered'),
                    'semantic': document.getElementById('count-semantic'),
                    'stereotype': document.getElementById('count-stereotype'),
                    'stereotyped': document.getElementById('count-stereotype') // Alias
                };
            }
            
            bindEvents() {
                // Save cursor position on any cursor movement
                this.editableDiv.addEventListener('keyup', () => this.saveCursorPosition());
                this.editableDiv.addEventListener('mouseup', () => this.saveCursorPosition());
                this.editableDiv.addEventListener('click', () => this.saveCursorPosition());
                
                // Input events - use composition events to handle typing better
                this.editableDiv.addEventListener('input', (e) => this.handleTextInput(e));
                this.editableDiv.addEventListener('keydown', (e) => this.handleKeyDown(e));
                this.editableDiv.addEventListener('keypress', (e) => this.handleKeyPress(e));
                this.editableDiv.addEventListener('paste', (e) => this.handlePaste(e));
                
                // Composition events for IME input (mobile, Asian languages)
                this.editableDiv.addEventListener('compositionstart', () => this.isComposing = true);
                this.editableDiv.addEventListener('compositionend', () => {
                    this.isComposing = false;
                    this.handleTextInput();
                });
                
                // Window resize to adjust editor height
                window.addEventListener('resize', () => this.adjustEditorHeight());
                
                // Button events
                document.getElementById('clear-btn').addEventListener('click', () => this.clearText());
                document.getElementById('demo-btn').addEventListener('click', () => this.loadDemoText());
            }
            
            setupEventListeners() {
                // Click outside to close suggestions
                document.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('bias-highlight')) {
                        this.closeAllTooltips();
                    }
                });
            }
            
            loadInitialDemo() {
                // Load a small demo text after 1 second
                setTimeout(() => {
                    if (this.editableDiv.textContent === '') {
                        this.loadDemoText();
                    }
                }, 1000);
            }
            
            adjustEditorHeight() {
                // Make editor take available vertical space
                const windowHeight = window.innerHeight;
                const headerHeight = document.querySelector('.header').offsetHeight;
                const resultsPanel = document.querySelector('.results-panel');
                const availableHeight = windowHeight - headerHeight - 100; // 100px for margins/padding
                
                // Set minimum heights
                this.editorPanel.style.minHeight = availableHeight + 'px';
                this.editableDiv.style.minHeight = (availableHeight - 100) + 'px';
                
                // Ensure results panel matches height
                if (resultsPanel) {
                    resultsPanel.style.minHeight = availableHeight + 'px';
                }
            }
            
            saveCursorPosition() {
                if (this.isUpdatingHighlights || this.isComposing) return;
                
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // Create a marker element to mark cursor position
                    if (this.cursorMarker) {
                        this.cursorMarker.remove();
                    }
                    
                    this.cursorMarker = document.createElement('span');
                    this.cursorMarker.id = 'cursor-marker';
                    this.cursorMarker.style.display = 'none';
                    this.cursorMarker.textContent = '\u200B'; // Zero-width space
                    
                    range.insertNode(this.cursorMarker);
                    
                    // Move cursor after the marker
                    range.setStartAfter(this.cursorMarker);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            
            restoreCursorPosition() {
                if (!this.cursorMarker || !this.cursorMarker.parentNode) {
                    this.setCursorToEnd();
                    return;
                }
                
                try {
                    const selection = window.getSelection();
                    const range = document.createRange();
                    
                    // Place cursor before the marker
                    range.setStartBefore(this.cursorMarker);
                    range.collapse(true);
                    
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    // Remove the marker
                    setTimeout(() => {
                        if (this.cursorMarker && this.cursorMarker.parentNode) {
                            this.cursorMarker.remove();
                            this.cursorMarker = null;
                        }
                    }, 0);
                    
                    // Ensure focus
                    this.editableDiv.focus();
                } catch (e) {
                    console.warn('Could not restore cursor position:', e);
                    this.setCursorToEnd();
                }
            }
            
            handleTextInput(e) {
                // Skip if composing (IME input)
                if (this.isComposing) return;
                
                // Skip if we just typed a space (to prevent immediate analysis)
                if (this.shouldSkipNextAnalysis) {
                    this.shouldSkipNextAnalysis = false;
                    
                    // Still update word count
                    const plainText = this.getPlainTextFromEditable();
                    const words = plainText.trim() ? plainText.trim().split(/\s+/).length : 0;
                    this.wordCount.textContent = words;
                    this.realTimeWords.textContent = words;
                    return;
                }
                
                // Save cursor position before analysis
                this.saveCursorPosition();
                
                // Get plain text from editable div
                const plainText = this.getPlainTextFromEditable();
                this.currentText = plainText;
                
                // Also update hidden textarea
                this.textInput.value = plainText;
                
                // Update word count
                const words = plainText.trim() ? plainText.trim().split(/\s+/).length : 0;
                this.wordCount.textContent = words;
                this.realTimeWords.textContent = words;
                
                // Show typing status
                this.statusIndicator.textContent = '‚óè Analyzing...';
                this.statusIndicator.style.color = '#f59e0b';
                
                // Debounce API call
                if (this.debounceTimer) {
                    clearTimeout(this.debounceTimer);
                }
                
                this.debounceTimer = setTimeout(() => {
                    this.analyzeText(plainText);
                }, 1000); // Increased debounce for better typing experience
            }
            
            getPlainTextFromEditable() {
                // Extract plain text from the editable div, removing HTML tags
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = this.editableDiv.innerHTML;
                
                // Remove cursor marker if present
                const marker = tempDiv.querySelector('#cursor-marker');
                if (marker) {
                    marker.remove();
                }
                
                // Replace <br> with newlines and preserve spaces
                let text = tempDiv.textContent || tempDiv.innerText || '';
                
                // Clean up multiple spaces but preserve single spaces
                text = text.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
                return text;
            }
            
            async analyzeText(text) {
                if (!text.trim()) {
                    this.updateUIWithEmptyResults();
                    // Clear highlights from editable div
                    this.editableDiv.textContent = '';
                    return;
                }
                
                try {
                    // REVERTED: Use the original endpoint
                    const response = await fetch('/api/real-time-analyze/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCookie('csrftoken')
                        },
                        body: JSON.stringify({ text: text })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Analysis failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.currentBiases = data.biases || [];
                    
                    // Set flag to prevent cursor position saving during highlight update
                    this.isUpdatingHighlights = true;
                    
                    // Update the editable div with highlighted HTML
                    await this.updateEditableWithHighlights(data.highlighted_html || data.highlighted_text, text);
                    
                    // Update all UI elements
                    this.updateScore(data.overall_score || data.score);
                    this.updateBiasCounts(data.biases);
                    this.updateSuggestions(data.biases);
                    this.updateStatus('success');
                    
                    // Restore cursor position
                    setTimeout(() => {
                        this.restoreCursorPosition();
                        this.isUpdatingHighlights = false;
                    }, 10);
                    
                } catch (error) {
                    console.error('Error analyzing text:', error);
                    this.updateStatus('error');
                    // Fallback to showing plain text
                    this.editableDiv.textContent = text;
                    this.isUpdatingHighlights = false;
                }
            }
            
            async updateEditableWithHighlights(highlightedHtml, originalText) {
                if (highlightedHtml && highlightedHtml.includes('bias-highlight')) {
                    // Store current scroll position
                    const scrollTop = this.editableDiv.scrollTop;
                    
                    // Preserve whitespace
                    let processedHtml = highlightedHtml
                        .replace(/&nbsp;/g, ' ')
                        .replace(/\s+/g, ' ');
                    
                    // Set the HTML directly to the editable div
                    this.editableDiv.innerHTML = processedHtml;
                    
                    // Restore scroll position
                    this.editableDiv.scrollTop = scrollTop;
                    
                    // Ensure the div remains focusable
                    this.editableDiv.setAttribute('contenteditable', 'true');
                    
                    // Add click handlers to the new bias highlights
                    this.setupBiasClickHandlers();
                } else {
                    // Fallback: just show plain text with preserved spaces
                    this.editableDiv.textContent = originalText;
                }
            }
            
            setupBiasClickHandlers() {
                // Add onclick handlers to all bias highlights in the editable div
                const biasElements = this.editableDiv.querySelectorAll('.bias-highlight');
                biasElements.forEach(element => {
                    const biasId = element.dataset.biasId;
                    if (biasId) {
                        // Remove any existing onclick to avoid duplicates
                        element.onclick = null;
                        
                        // Add new onclick handler
                        element.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            showBiasSuggestion(biasId);
                        };
                        
                        // Add hover effect
                        element.addEventListener('mouseenter', () => {
                            element.style.transform = 'translateY(-1px)';
                            element.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                        });
                        
                        element.addEventListener('mouseleave', () => {
                            element.style.transform = '';
                            element.style.boxShadow = '';
                        });
                    }
                });
            }
            
            setCursorToEnd() {
                // Set cursor to the end of the editable div
                const range = document.createRange();
                const selection = window.getSelection();
                
                // If there are child nodes, select the last one
                if (this.editableDiv.childNodes.length > 0) {
                    const lastNode = this.editableDiv.lastChild;
                    if (lastNode.nodeType === Node.TEXT_NODE) {
                        range.setStart(lastNode, lastNode.length);
                    } else {
                        range.setStartAfter(lastNode);
                    }
                    range.collapse(true);
                } else {
                    // If empty, select the div itself
                    range.selectNodeContents(this.editableDiv);
                    range.collapse(false);
                }
                
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Ensure focus
                this.editableDiv.focus();
            }
            
            handlePaste(e) {
                e.preventDefault();
                
                // Save cursor position before paste
                this.saveCursorPosition();
                
                // Get plain text from clipboard
                const text = e.clipboardData.getData('text/plain');
                
                // Insert at cursor position
                document.execCommand('insertText', false, text);
                
                // Trigger input event
                this.editableDiv.dispatchEvent(new Event('input'));
            }
            
            handleKeyDown(e) {
                // Don't save position during composition
                if (this.isComposing) return;
                
                // Handle tab key
                if (e.key === 'Tab') {
                    e.preventDefault();
                    this.saveCursorPosition();
                    document.execCommand('insertText', false, '    ');
                    this.editableDiv.dispatchEvent(new Event('input'));
                    return false;
                }
                
                // Handle Enter key
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.saveCursorPosition();
                    document.execCommand('insertHTML', false, '<br><br>');
                    this.editableDiv.dispatchEvent(new Event('input'));
                    return false;
                }
                
                // For space key - just let it happen naturally
                if (e.key === ' ') {
                    // Mark that we should skip immediate analysis after space
                    this.shouldSkipNextAnalysis = true;
                    
                    // Let the default space insertion happen
                    // We'll handle analysis on the next non-space character
                }
            }
            
            handleKeyPress(e) {
                // Track when user is actively typing (not just space)
                if (e.key !== ' ' && e.key !== 'Enter' && e.key !== 'Tab') {
                    this.shouldSkipNextAnalysis = false;
                }
            }
            
            updateScore(score) {
                const safeScore = Math.max(0, Math.min(100, score || 100));
                
                // Update score circle
                const circumference = 2 * Math.PI * 16; // 2œÄr
                const offset = circumference - (safeScore / 100) * circumference;
                this.scoreCircle.style.strokeDashoffset = offset;
                
                // Update score values
                this.scoreValue.textContent = safeScore;
                this.realTimeScore.textContent = safeScore;
                
                // Update score circle color based on score
                let color = '#10b981'; // Green for good
                if (safeScore < 70) color = '#f59e0b'; // Yellow for medium
                if (safeScore < 40) color = '#ef4444'; // Red for poor
                this.scoreCircle.style.stroke = color;
            }
            
            updateBiasCounts(biases) {
                // Reset all counts
                Object.values(this.biasCounts).forEach(el => {
                    if (el && el.textContent !== undefined) {
                        el.textContent = '0';
                    }
                });
                this.realTimeBiases.textContent = '0';
                
                if (!biases || biases.length === 0) return;
                
                // Count biases by type - map backend types to frontend IDs
                const typeMapping = {
                    'pronoun': 'pronoun',
                    'agentic_communal': 'agentic_communal',
                    'gendered_terms': 'gendered_terms', 
                    'semantic': 'semantic',
                    'stereotype': 'stereotype',
                    'stereotyped': 'stereotype'
                };
                
                const counts = {};
                biases.forEach(bias => {
                    const backendType = bias.type || 'unknown';
                    const frontendType = typeMapping[backendType] || backendType;
                    counts[frontendType] = (counts[frontendType] || 0) + 1;
                });
                
                // Update UI
                Object.entries(counts).forEach(([type, count]) => {
                    if (this.biasCounts[type]) {
                        this.biasCounts[type].textContent = count;
                    } else {
                        console.warn(`No counter element found for bias type: ${type}`);
                    }
                });
                
                this.realTimeBiases.textContent = biases.length;
            }
            
            updateSuggestions(biases) {
                if (!biases || biases.length === 0) {
                    this.showEmptySuggestions();
                    return;
                }
                
                // Show the first 3 biases as suggestions
                const recentBiases = biases.slice(0, 3);
                this.renderSuggestions(recentBiases);
            }
            
            renderSuggestions(biases) {
                this.suggestionsContainer.innerHTML = '';
                
                biases.forEach((bias, index) => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'suggestion-item';
                    suggestion.dataset.biasId = bias.id;
                    
                    suggestion.innerHTML = `
                        <div class="suggestion-text">
                            <strong>${(bias.type || 'bias').replace('_', ' ').toUpperCase()}:</strong>
                            "${bias.target_text || bias.targetText || ''}" - ${bias.description || 'Bias detected'}
                        </div>
                        <div class="suggestion-actions">
                            <input type="text" 
                                class="suggestion-replace" 
                                placeholder="Replace with..."
                                value="${(bias.alternatives && bias.alternatives[0]) || ''}">
                            <button class="btn btn-primary btn-small" onclick="applySuggestionFromList('${bias.id}', this)">
                                Apply
                            </button>
                        </div>
                    `;
                    
                    this.suggestionsContainer.appendChild(suggestion);
                });
            }
            
            showEmptySuggestions() {
                this.suggestionsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>Great! No biases detected in your text.</p>
                    </div>
                `;
            }
            
            updateUIWithEmptyResults() {
                this.updateScore(100);
                this.updateBiasCounts([]);
                this.showEmptySuggestions();
                this.updateStatus('ready');
            }
            
            updateStatus(status) {
                const statusConfig = {
                    ready: { text: '‚óè Ready', color: '#10b981' },
                    analyzing: { text: '‚óè Analyzing...', color: '#f59e0b' },
                    success: { text: '‚óè Analysis complete', color: '#10b981' },
                    error: { text: '‚óè Error analyzing', color: '#ef4444' }
                };
                
                const config = statusConfig[status] || statusConfig.ready;
                this.statusIndicator.textContent = config.text;
                this.statusIndicator.style.color = config.color;
            }
            
            loadDemoText() {
                // Save cursor position before loading demo
                this.saveCursorPosition();
                
                const demoText = `The CEO announced his vision for the company's future. He was very aggressive in pursuing new markets and made decisive moves that showed strong leadership.

        Meanwhile, the nurses in our hospital provide emotional support to patients. They are always caring and nurturing, which makes them perfect for their roles.

        The chairman will present the award to the best engineer, while the stewardess will assist passengers with their needs.`;

                // Set plain text first
                this.editableDiv.textContent = demoText;
                
                // Trigger analysis
                setTimeout(() => {
                    this.editableDiv.dispatchEvent(new Event('input'));
                }, 100);
                
                // Focus and set cursor to end
                setTimeout(() => {
                    this.editableDiv.focus();
                    this.setCursorToEnd();
                }, 200);
            }
            
            clearText() {
                this.editableDiv.innerHTML = '';
                this.textInput.value = '';
                this.currentText = '';
                this.currentBiases = [];
                this.lastCursorPosition = null;
                this.shouldSkipNextAnalysis = false;
                
                // Remove cursor marker if exists
                if (this.cursorMarker) {
                    this.cursorMarker.remove();
                    this.cursorMarker = null;
                }
                
                // Reset all UI
                this.updateUIWithEmptyResults();
                
                // Focus
                setTimeout(() => {
                    this.editableDiv.focus();
                    this.setCursorToEnd();
                }, 100);
            }
            
            closeAllTooltips() {
                document.querySelectorAll('.bias-tooltip').forEach(tooltip => {
                    tooltip.classList.remove('show');
                });
            }
            
            getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        }

        function showBiasSuggestion(biasId) {
            // Close any existing popups
            closeAllPopups();
            
            // Find the bias in current biases
            const bias = equityMirror.currentBiases.find(b => b.id === biasId);
            if (!bias) return;
            
            // Create and show popup
            const popup = document.createElement('div');
            popup.className = 'bias-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                z-index: 1000;
                max-width: 400px;
                width: 90%;
            `;
            
            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: #4f46e5;">Fix Bias</h3>
                    <button onclick="closeAllPopups()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">√ó</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <p><strong>Issue:</strong> ${bias.description}</p>
                    <p><strong>Suggestion:</strong> ${bias.suggestion}</p>
                </div>
                ${bias.alternatives && bias.alternatives.length > 0 ? `
                    <div style="margin-bottom: 16px;">
                        <p><strong>Alternatives:</strong></p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${bias.alternatives.map(alt => 
                                `<span style="background: #f1f5f9; padding: 6px 12px; border-radius: 6px; cursor: pointer;" 
                                      onclick="applySuggestion('${biasId}', '${alt.replace(/'/g, "\\'")}')">
                                    ${alt}
                                 </span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
                <div>
                    <input type="text" 
                           id="custom-replace-${biasId}" 
                           placeholder="Or enter custom replacement..." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 12px;">
                    <button onclick="applyCustomSuggestion('${biasId}')" 
                            style="width: 100%; padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Apply Change
                    </button>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Add overlay
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            `;
            overlay.onclick = closeAllPopups;
            document.body.appendChild(overlay);
        }

        function closeAllPopups() {
            document.querySelectorAll('.bias-popup, .popup-overlay').forEach(el => el.remove());
        }

        function applySuggestion(biasId, replacement) {
            console.log('applySuggestion called:', { biasId, replacement });
            
            // Find the bias
            const bias = equityMirror.currentBiases.find(b => b.id === biasId);
            if (!bias) {
                console.error('Bias not found:', biasId);
                return;
            }
            
            // Get the editable div
            const editor = equityMirror.editableDiv;
            
            // METHOD 1: Direct DOM replacement
            const biasElement = editor.querySelector(`span[data-bias-id="${biasId}"]`);
            
            if (biasElement) {
                // Create replacement text
                const replacementSpan = document.createElement('span');
                replacementSpan.textContent = replacement;
                replacementSpan.style.color = '#059669';
                replacementSpan.style.fontWeight = '600';
                
                // Replace the element
                biasElement.replaceWith(replacementSpan);
                console.log('Direct DOM replacement successful');
            } else {
                // METHOD 2: Text content replacement
                console.log('Direct element not found, using text replacement');
                const currentText = editor.textContent || editor.innerText;
                const escapedText = bias.target_text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const updatedText = currentText.replace(new RegExp(escapedText, 'g'), replacement);
                editor.textContent = updatedText;
            }
            
            // Update the hidden textarea
            const plainText = equityMirror.getPlainTextFromEditable();
            equityMirror.textInput.value = plainText;
            
            // Trigger re-analysis after a small delay
            setTimeout(() => {
                editor.dispatchEvent(new Event('input'));
            }, 100);
            
            // Close the popup
            closeAllPopups();
        }

        function applySuggestionFromList(biasId, buttonElement) {
            const suggestionItem = buttonElement.closest('.suggestion-item');
            const replacementInput = suggestionItem.querySelector('.suggestion-replace');
            const replacement = replacementInput.value.trim();
            
            if (!replacement) {
                alert('Please enter a replacement text.');
                return;
            }
            
            applySuggestion(biasId, replacement);
        }

        function applyCustomSuggestion(biasId) {
            const input = document.getElementById(`custom-replace-${biasId}`);
            if (input && input.value.trim()) {
                applySuggestion(biasId, input.value.trim());
            }
        }

        // Make functions available globally
        window.showBiasSuggestion = showBiasSuggestion;
        window.closeAllPopups = closeAllPopups;
        window.applySuggestion = applySuggestion;
        window.applyCustomSuggestion = applyCustomSuggestion;
        
        // Initialize the app
        let equityMirror;
        document.addEventListener('DOMContentLoaded', () => {
            equityMirror = new EquityMirror();
            window.equityMirror = equityMirror; // Make it globally available for onclick handlers
        });
    </script>
</body>
</html>
